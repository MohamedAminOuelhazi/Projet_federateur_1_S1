\chapter{CHAPITRE 4 : \textbf{Sprint 2 - Gestion de l'espace Assistant}}
\begin{spacing}{1.2}
\minitoc
\thispagestyle{MyStyle}
\end{spacing}
\newpage

\section{INTRODUCTION}
Dans ce chapitre, nous présentons le deuxième sprint intitulé "Gestion de l'espace Assistant". Après avoir développé l'espace médecin lors du sprint 1, nous nous concentrons maintenant sur les fonctionnalités dédiées aux assistants médicaux avec un système de permissions restrictives. Nous allons commencer par la présentation du backlog du sprint 2, suivie de la spécification fonctionnelle avec diagrammes UML, de la conception, et enfin nous illustrerons ce sprint à l'aide de captures d'écran. L'accent est mis sur le contrôle d'accès basé sur les rôles (RBAC) pour garantir la confidentialité des données médicales.

\section{Backlog du sprint 2}
Le tableau \ref{tableau:Backlog du sprint 2} présente l'ensemble des user stories sélectionnées pour le sprint 2, focalisées sur l'espace assistant avec permissions restreintes.

\begin{longtable}{|p{3.5cm}|p{9cm}|p{1.5cm}|p{2cm}|}
\caption{Backlog du sprint 2 - Espace Assistant}
\label{tableau:Backlog du sprint 2}
\\
\hline
 \cellcolor[HTML]{FFF2CC}Fonctionnalités  
& \cellcolor[HTML]{FFF2CC}User Stories   
& \cellcolor[HTML]{FFF2CC}Priorités
& \cellcolor[HTML]{FFF2CC}Estimation\\
\hline
\endfirsthead
\hline
 \cellcolor[HTML]{FFF2CC}Fonctionnalités  
& \cellcolor[HTML]{FFF2CC}User Stories   
& \cellcolor[HTML]{FFF2CC}Priorités
& \cellcolor[HTML]{FFF2CC}Estimation\\
\hline
\endhead
\multirow{2}{10em}{Gestion d'Authentification}
& En tant qu'assistant, je veux m'authentifier pour accéder à mon espace sécurisé & Élevée & 2 jours
\\\cline{2-4}
& En tant qu'assistant, je veux me déconnecter pour quitter ma session en toute sécurité & Moyenne & 1 jour
\\ \hline
\multirow{4}{8em}{Gérer les Patients}
& En tant qu'assistant, je veux consulter la liste de tous les patients avec recherche et filtres & Moyenne & 3 jours
\\\cline{2-4}
& En tant qu'assistant, je veux modifier les informations d'un patient (nom, prénom, téléphone, email) via PUT /api/patients/update/\{id\} & Moyenne & 2 jours
\\\cline{2-4}
& En tant qu'assistant, je veux consulter la fiche complète d'un patient (données personnelles uniquement) & Moyenne & 2 jours
\\ \hline
\multirow{4}{8em}{Gérer les Rendez-vous}
& En tant qu'assistant, je veux créer un rendez-vous pour un patient en vérifiant la disponibilité du médecin & Élevée & 5 jours
\\\cline{2-4}
& En tant qu'assistant, je veux consulter le calendrier de rendez-vous avec vue hebdomadaire/mensuelle & Moyenne & 3 jours
\\\cline{2-4}
& En tant qu'assistant, je veux modifier un rendez-vous existant (date, heure, motif) & Moyenne & 3 jours
\\\cline{2-4}
& En tant qu'assistant, je veux annuler un rendez-vous avec notification automatique au patient & Moyenne & 2 jours
\\ \hline
\multirow{2}{8em}{Gérer les Factures (Restreint)}
& En tant qu'assistant, je veux créer une facture pour un patient avec montant et description & Élevée & 3 jours
\\\cline{2-4}
& En tant qu'assistant, je veux consulter la liste des factures (lecture seule, sans accès aux statistiques financières) & Moyenne & 2 jours
\\ \hline
\multirow{1}{8em}{Restrictions de Sécurité}
& En tant que système, je dois interdire à l'assistant l'accès aux rapports financiers et à la gestion d'autres assistants & Élevée & 3 jours
\\ \hline
\end{longtable}

Chaque user story représente une fonctionnalité que l'assistant souhaite pouvoir réaliser dans le système, avec des restrictions importantes pour garantir la confidentialité des données. Les priorités sont classées en élevée, moyenne ou faible, reflétant l'importance relative de chaque user story. 

\textbf{Contraintes de sécurité spécifiques au rôle Assistant :}
\begin{itemize}[leftmargin=2cm, topsep=0pt]
    \begin{spacing}{1.25}
    \item \textbf{Accès INTERDIT} aux rapports financiers et statistiques détaillées
    \item \textbf{Accès INTERDIT} à la gestion d'autres assistants
    \item \textbf{Accès LIMITÉ} aux factures : création pour patients liés uniquement, enregistrement paiements
    \item \textbf{Accès LIMITÉ} aux patients : consultation et modification des données personnelles
    \item \textbf{Inscription nouveaux patients} : via page publique /register (pas depuis dashboard)
    \end{spacing}
\end{itemize}

\section{Spécifications fonctionnelles}
Dans cette partie, nous présentons le diagramme de cas d'utilisation du sprint 2 ainsi que les descriptions textuelles détaillées.

\subsection{Diagramme de cas d'utilisation du sprint 2}
Le diagramme de cas d'utilisation du sprint 2, présenté dans la figure 4.1, illustre les besoins fonctionnels sous la forme d'interactions entre l'assistant et le système, avec mise en évidence des restrictions d'accès.

\begin{figure}[H]%
    \center%
    \setlength{\fboxsep}{5pt}%
    \setlength{\fboxrule}{0.5pt}%
    \includegraphics[width=14cm,height=12cm]{images/sprint2-assistant-usecase.png}%
    \caption{Diagramme de cas d'utilisation du sprint 2 - Espace Assistant}%
\end{figure}

\subsection{Descriptions textuelles}
L'objectif de cette activité est de décrire textuellement les scénarios des cas d'utilisation. Il faut préciser comment chaque scénario commence, comment il se termine et comment l'assistant interagit avec l'application web.

\textbf{Description textuelle du cas d'utilisation "S'authentifier - Assistant" :}\\
Le tableau \ref{tableau:Description textuelle du cas d'utilisation "S'authentifier - Assistant"} présente la description textuelle du cas d'utilisation "S'authentifier". Ce scénario commence lorsque l'assistant ouvre l'application et accède à l'écran de connexion.

\begin{longtable}{|p{5cm}|p{10cm}|}
\caption{Description textuelle du cas d'utilisation "S'authentifier - Assistant"}
\label{tableau:Description textuelle du cas d'utilisation "S'authentifier - Assistant"}
\\
\hline
\cellcolor[HTML]{FFF2CC}Cas d'utilisation  
& \cellcolor[HTML]{FFF2CC}S'authentifier - Assistant\\
\hline
\endfirsthead
\hline
\cellcolor[HTML]{FFF2CC}Cas d'utilisation  
& \cellcolor[HTML]{FFF2CC}S'authentifier - Assistant\\
\hline
\endhead
Acteur & Assistant
\\ \hline
Précondition & 
\begin{enumerate}
    \item Le système est en service.
    \item L'assistant possède un compte actif créé par le médecin.
    \item Le compte n'est pas désactivé (champ actif = true).
\end{enumerate}
\\ \hline
Post-condition & 
\begin{enumerate}
    \item L'assistant est authentifié avec un token JWT contenant son rôle "ASSISTANT".
    \item Le système affiche le tableau de bord assistant avec accès restreint aux fonctionnalités autorisées.
    \item L'assistant ne peut PAS accéder aux dossiers médicaux, rapports financiers, ni gestion des assistants.
\end{enumerate}
\\ \hline
Scénario principal & 
\begin{enumerate}
    \item L'assistant accède à la page de connexion (/login).
    \item Le système affiche le formulaire d'authentification.
    \item L'assistant saisit son email et son mot de passe.
    \item L'assistant clique sur "Se connecter".
    \item Le système vérifie les identifiants via l'API REST /api/auth/login.
    \item Le système vérifie que le compte est actif (actif = true).
    \item Le système génère un token JWT avec le rôle "ASSISTANT".
    \item Le système stocke le token dans le localStorage du navigateur.
    \item Le système redirige vers /dashboard/assistant (tableau de bord assistant).
    \item Le frontend affiche uniquement les menus autorisés : Patients, Rendez-vous, Factures (création uniquement).
\end{enumerate}
\\ \hline
Scénario alternatif & 
\begin{enumerate}
    \item L'assistant saisit des données incomplètes \(\rightarrow\) affichage d'un message d'erreur "Tous les champs sont obligatoires".
    \item L'assistant saisit des identifiants incorrects \(\rightarrow\) affichage d'un message d'erreur "Email ou mot de passe incorrect".
    \item Le compte est désactivé par le médecin \(\rightarrow\) affichage d'un message d'erreur "Compte désactivé, contactez le médecin".
    \item L'assistant tente d'accéder à /dashboard/dossiers (dossiers médicaux) \(\rightarrow\) redirection vers /dashboard/assistant avec message "Accès non autorisé".
\end{enumerate}
\\\hline
\end{longtable}

\textbf{Description textuelle du cas d'utilisation "Consulter les Patients" :}\\
Le tableau \ref{tableau:Description textuelle du cas d'utilisation "Consulter les Patients"} présente la description textuelle du cas d'utilisation "Consulter les Patients". Ce scénario permet à l'assistant de consulter la liste des patients du cabinet. Note importante : L'enregistrement de nouveaux patients se fait via la page publique d'inscription (/register) pour des raisons de sécurité et de gestion des comptes utilisateurs.

\begin{longtable}{|p{5cm}|p{10cm}|}
\caption{Description textuelle du cas d'utilisation "Consulter les Patients"}
\label{tableau:Description textuelle du cas d'utilisation "Consulter les Patients"}
\\
\hline
\cellcolor[HTML]{FFF2CC}Cas d'utilisation  
& \cellcolor[HTML]{FFF2CC}Consulter les Patients\\
\hline
\endfirsthead
\hline
\cellcolor[HTML]{FFF2CC}Cas d'utilisation  
& \cellcolor[HTML]{FFF2CC}Consulter les Patients\\
\hline
\endhead
Acteur & Assistant
\\ \hline
Précondition & 
\begin{enumerate}
    \item L'assistant est authentifié avec le rôle "ASSISTANT".
    \item L'assistant a accès à la section "Gestion des Patients".
\end{enumerate}
\\ \hline
Post-condition & 
\begin{enumerate}
    \item L'assistant visualise la liste des patients.
    \item L'assistant peut filtrer et rechercher des patients.
\end{enumerate}
\\ \hline
Scénario principal & 
\begin{enumerate}
    \item L'assistant accède à la section "Patients" (/dashboard/patients).
    \item Le système affiche la liste complète des patients via GET /api/patients/allPatients.
    \item L'assistant peut utiliser la barre de recherche pour filtrer par nom, prénom, email ou téléphone.
    \item L'assistant peut voir les informations basiques de chaque patient (nom, prénom, date de naissance, email, téléphone).
    \item L'assistant peut cliquer sur un patient pour voir ses détails complets.
    \item L'assistant peut modifier les informations d'un patient via le bouton "Modifier".
\end{enumerate}
\\ \hline
Scénario alternatif & 
\begin{enumerate}
    \item L'assistant laisse des champs obligatoires vides (nom, prénom, date de naissance, téléphone) \(\rightarrow\) affichage d'erreurs de validation.
    \item Le format de l'email est invalide \(\rightarrow\) affichage d'un message "Email invalide".
    \item La date de naissance est invalide ou dans le futur \(\rightarrow\) affichage d'un message "Date de naissance invalide".
    \item L'email est déjà utilisé \(\rightarrow\) affichage d'un message "Un patient avec cet email existe déjà".
    \item Erreur serveur lors de la création \(\rightarrow\) affichage d'un message "Erreur lors de la création, veuillez réessayer".
\end{enumerate}
\\\hline
\end{longtable}

\textbf{Description textuelle du cas d'utilisation "Créer un Rendez-vous" :}\\
Le tableau \ref{tableau:Description textuelle du cas d'utilisation "Créer un Rendez-vous"} présente la description textuelle du cas d'utilisation "Créer un Rendez-vous". Ce scénario permet à l'assistant de planifier un rendez-vous entre un patient et le médecin.

\begin{longtable}{|p{5cm}|p{10cm}|}
\caption{Description textuelle du cas d'utilisation "Créer un Rendez-vous"}
\label{tableau:Description textuelle du cas d'utilisation "Créer un Rendez-vous"}
\\
\hline
\cellcolor[HTML]{FFF2CC}Cas d'utilisation  
& \cellcolor[HTML]{FFF2CC}Créer un Rendez-vous\\
\hline
\endfirsthead
\hline
\cellcolor[HTML]{FFF2CC}Cas d'utilisation  
& \cellcolor[HTML]{FFF2CC}Créer un Rendez-vous\\
\hline
\endhead
Acteur & Assistant
\\ \hline
Précondition & 
\begin{enumerate}
    \item L'assistant est authentifié avec le rôle "ASSISTANT".
    \item Un patient existe dans le système.
    \item L'assistant a accès à la section "Rendez-vous".
\end{enumerate}
\\ \hline
Post-condition & 
\begin{enumerate}
    \item Un nouveau rendez-vous est créé avec le statut "CONFIRME".
    \item Le rendez-vous est associé au patient, au médecin et à l'assistant (créateur).
    \item Une notification par email est envoyée automatiquement au patient avec les détails du rendez-vous.
    \item Le rendez-vous apparaît dans le calendrier du médecin et de l'assistant.
    \item Le créneau horaire est bloqué pour éviter les doubles réservations.
\end{enumerate}
\\ \hline
Scénario principal & 
\begin{enumerate}
    \item L'assistant accède à la section "Rendez-vous" (/dashboard/assistant/rendezvous).
    \item L'assistant clique sur "Créer un Rendez-vous".
    \item Le système affiche le formulaire de création avec les champs : sélection patient, date, heure de début, heure de fin, motif.
    \item L'assistant sélectionne le patient dans la liste déroulante.
    \item L'assistant sélectionne la date et les horaires du rendez-vous.
    \item L'assistant saisit le motif de consultation (ex: "Consultation générale", "Suivi traitement").
    \item L'assistant clique sur "Créer".
    \item Le système valide les données (patient sélectionné, date dans le futur, heure fin > heure début, motif non vide).
    \item Le système vérifie la disponibilité du médecin via GET /api/rendezvous/check-disponibilite?date=YYYY-MM-DD\&heureDebut=HH:MM\&heureFin=HH:MM.
    \item Si le créneau est disponible, le système envoie une requête POST /api/rendezvous avec les données.
    \item Le backend enregistre le rendez-vous avec statut "CONFIRME" et référence l'assistant comme créateur.
    \item Le système envoie un email automatique au patient avec les détails du rendez-vous.
    \item Le système affiche un message de succès "Rendez-vous créé avec succès, le patient a été notifié par email".
    \item Le système rafraîchit le calendrier de rendez-vous.
\end{enumerate}
\\ \hline
Scénario alternatif & 
\begin{enumerate}
    \item Aucun patient sélectionné \(\rightarrow\) affichage d'un message "Veuillez sélectionner un patient".
    \item La date sélectionnée est dans le passé \(\rightarrow\) affichage d'un message "La date doit être dans le futur".
    \item L'heure de fin est antérieure ou égale à l'heure de début \(\rightarrow\) affichage d'un message "L'heure de fin doit être postérieure à l'heure de début".
    \item Le créneau horaire est déjà occupé (conflit avec un autre rendez-vous) \(\rightarrow\) affichage d'un message "Ce créneau est déjà réservé, veuillez choisir une autre heure".
    \item Le motif est vide \(\rightarrow\) affichage d'un message "Le motif de consultation est obligatoire".
    \item Erreur serveur lors de la création \(\rightarrow\) affichage d'un message "Erreur lors de la création, veuillez réessayer".
    \item Erreur d'envoi d'email \(\rightarrow\) le rendez-vous est créé mais un message avertit "Rendez-vous créé mais échec de l'envoi de l'email au patient".
\end{enumerate}
\\\hline
\end{longtable}

\textbf{Description textuelle du cas d'utilisation "Créer une Facture (Restreint)" :}\\
Le tableau \ref{tableau:Description textuelle du cas d'utilisation "Créer une Facture - Assistant"} présente la description textuelle du cas d'utilisation "Créer une Facture" avec restrictions pour l'assistant.

\begin{longtable}{|p{5cm}|p{10cm}|}
\caption{Description textuelle du cas d'utilisation "Créer une Facture - Assistant"}
\label{tableau:Description textuelle du cas d'utilisation "Créer une Facture - Assistant"}
\\
\hline
\cellcolor[HTML]{FFF2CC}Cas d'utilisation  
& \cellcolor[HTML]{FFF2CC}Créer une Facture (Restreint)\\
\hline
\endfirsthead
\hline
\cellcolor[HTML]{FFF2CC}Cas d'utilisation  
& \cellcolor[HTML]{FFF2CC}Créer une Facture (Restreint)\\
\hline
\endhead
Acteur & Assistant
\\ \hline
Précondition & 
\begin{enumerate}
    \item L'assistant est authentifié avec le rôle "ASSISTANT".
    \item Un patient existe dans le système.
    \item L'assistant a accès à la section "Factures" en mode création uniquement.
\end{enumerate}
\\ \hline
Post-condition & 
\begin{enumerate}
    \item Une nouvelle facture est créée avec le statut "IMPAYEE".
    \item La facture contient : patient, montant total, description des actes, date d'émission.
    \item Un numéro de facture unique est généré automatiquement.
    \item La facture est créée par l'assistant mais associée au médecin propriétaire du cabinet.
    \item \textbf{RESTRICTION :} L'assistant ne peut PAS modifier, supprimer ni enregistrer de paiement sur cette facture.
\end{enumerate}
\\ \hline
Scénario principal & 
\begin{enumerate}
    \item L'assistant accède à la section "Factures" (/dashboard/assistant/factures).
    \item L'assistant clique sur "Créer une Facture".
    \item Le système affiche le formulaire de création avec les champs : sélection patient, montant, description des actes.
    \item L'assistant sélectionne le patient dans la liste déroulante.
    \item L'assistant saisit le montant et la description (ex: "Consultation + Ordonnance").
    \item L'assistant clique sur "Créer".
    \item Le système valide les données (montant > 0, patient sélectionné, description non vide).
    \item Le système génère un numéro de facture unique (format: FAC-YYYY-XXXX).
    \item Le système envoie une requête POST /api/factures avec les données et l'ID de l'assistant créateur.
    \item Le backend enregistre la facture avec statut "IMPAYEE", date d'émission, et référence le médecin propriétaire + assistant créateur.
    \item Le système affiche un message de succès "Facture créée avec succès".
    \item Le système affiche la liste des factures en mode lecture seule (pas de boutons modifier/supprimer/payer pour l'assistant).
\end{enumerate}
\\ \hline
Scénario alternatif & 
\begin{enumerate}
    \item Aucun patient sélectionné \(\rightarrow\) affichage d'un message "Veuillez sélectionner un patient".
    \item Le montant est inférieur ou égal à 0 \(\rightarrow\) affichage d'un message "Le montant doit être supérieur à 0".
    \item La description est vide \(\rightarrow\) affichage d'un message "La description est obligatoire".
    \item L'assistant tente d'accéder à /api/factures/{id}/paiement (enregistrer paiement) \(\rightarrow\) erreur 403 Forbidden "Accès non autorisé pour le rôle ASSISTANT".
    \item Erreur serveur lors de la création \(\rightarrow\) affichage d'un message "Erreur lors de la création, veuillez réessayer".
\end{enumerate}
\\\hline
\end{longtable}

\textbf{Description textuelle du cas d'utilisation "Annuler un Rendez-vous" :}\\
Le tableau \ref{tableau:Description textuelle du cas d'utilisation "Annuler un Rendez-vous"} présente la description textuelle du cas d'utilisation "Annuler un Rendez-vous". Ce scénario permet à l'assistant d'annuler un rendez-vous existant.

\begin{longtable}{|p{5cm}|p{10cm}|}
\caption{Description textuelle du cas d'utilisation "Annuler un Rendez-vous"}
\label{tableau:Description textuelle du cas d'utilisation "Annuler un Rendez-vous"}
\\
\hline
\cellcolor[HTML]{FFF2CC}Cas d'utilisation  
& \cellcolor[HTML]{FFF2CC}Annuler un Rendez-vous\\
\hline
\endfirsthead
\hline
\cellcolor[HTML]{FFF2CC}Cas d'utilisation  
& \cellcolor[HTML]{FFF2CC}Annuler un Rendez-vous\\
\hline
\endhead
Acteur & Assistant
\\ \hline
Précondition & 
\begin{enumerate}
    \item L'assistant est authentifié avec le rôle "ASSISTANT".
    \item Un rendez-vous existe avec le statut "CONFIRME".
    \item L'assistant a accès à la section "Rendez-vous".
\end{enumerate}
\\ \hline
Post-condition & 
\begin{enumerate}
    \item Le statut du rendez-vous passe de "CONFIRME" à "ANNULE".
    \item Le créneau horaire est libéré et redevient disponible.
    \item Une notification par email est envoyée automatiquement au patient pour l'informer de l'annulation.
    \item Le rendez-vous reste visible dans l'historique mais marqué comme "ANNULE".
\end{enumerate}
\\ \hline
Scénario principal & 
\begin{enumerate}
    \item L'assistant accède à la section "Rendez-vous" et visualise le calendrier.
    \item L'assistant sélectionne un rendez-vous avec le statut "CONFIRME".
    \item L'assistant clique sur "Annuler le Rendez-vous".
    \item Le système affiche une boîte de dialogue de confirmation "Êtes-vous sûr de vouloir annuler ce rendez-vous ?".
    \item L'assistant confirme l'annulation.
    \item Le système envoie une requête PUT /api/rendezvous/{id}/annuler.
    \item Le backend met à jour le statut du rendez-vous à "ANNULE".
    \item Le backend envoie un email automatique au patient avec le message "Votre rendez-vous du [DATE] à [HEURE] a été annulé".
    \item Le système affiche un message de succès "Rendez-vous annulé avec succès, le patient a été notifié par email".
    \item Le système rafraîchit le calendrier (le rendez-vous apparaît en gris/barré ou disparaît selon l'affichage).
\end{enumerate}
\\ \hline
Scénario alternatif & 
\begin{enumerate}
    \item L'assistant annule la confirmation dans la boîte de dialogue \(\rightarrow\) le rendez-vous reste inchangé.
    \item Le rendez-vous est déjà annulé \(\rightarrow\) affichage d'un message "Ce rendez-vous est déjà annulé".
    \item Erreur serveur lors de l'annulation \(\rightarrow\) affichage d'un message "Erreur lors de l'annulation, veuillez réessayer".
    \item Erreur d'envoi d'email \(\rightarrow\) le rendez-vous est annulé mais un message avertit "Rendez-vous annulé mais échec de l'envoi de l'email au patient".
\end{enumerate}
\\\hline
\end{longtable}

\section{Conception}
Dans cette section, nous présentons les diagrammes de conception du sprint 2, notamment les diagrammes de séquence et le diagramme de classes étendu.

\subsection{Diagrammes de séquence}

\textbf{Diagramme de séquence "Créer un Rendez-vous avec Vérification Disponibilité" :}\\
La figure 4.2 illustre le diagramme de séquence de création d'un rendez-vous par l'assistant, incluant la vérification automatique de la disponibilité du médecin et l'envoi d'email au patient.

\begin{figure}[H]%
    \center%
    \setlength{\fboxsep}{5pt}%
    \setlength{\fboxrule}{0.5pt}%
    \includegraphics[width=16cm,height=14cm]{images/sequence-creer-rendezvous.png}%
    \caption{Diagramme de séquence - Créer un Rendez-vous}%
\end{figure}

\textbf{Diagramme de séquence "Contrôle d'Accès RBAC - Tentative d'Accès Interdit" :}\\
La figure 4.3 illustre le diagramme de séquence montrant le fonctionnement du contrôle d'accès basé sur les rôles (RBAC) lorsqu'un assistant tente d'accéder à un endpoint interdit (dossiers médicaux).

\begin{figure}[H]%
    \center%
    \setlength{\fboxsep}{5pt}%
    \setlength{\fboxrule}{0.5pt}%
    \includegraphics[width=15cm,height=12cm]{images/sequence-rbac-assistant.png}%
    \caption{Diagramme de séquence - Contrôle d'Accès RBAC}%
\end{figure}

\subsection{Diagramme de classes du sprint 2}

Le diagramme de classes du sprint 2, présenté dans la figure 4.4, illustre les relations entre les entités principales du système avec focus sur les restrictions d'accès pour l'assistant.

\begin{figure}[H]%
    \center%
    \setlength{\fboxsep}{5pt}%
    \setlength{\fboxrule}{0.5pt}%
    \includegraphics[width=16cm,height=14cm]{images/class-diagram-sprint2.png}%
    \caption{Diagramme de classes - Sprint 2 avec RBAC}%
\end{figure}

\textbf{Ajouts et modifications pour le Sprint 2 :}

\begin{itemize}[leftmargin=2cm, topsep=0pt]
    \begin{spacing}{1.25}
    \item \textbf{RendezVous :} Ajout de l'attribut \textit{assistantCreateur} (ManyToOne avec User) pour tracer quel assistant a créé le rendez-vous. Ajout de méthodes de validation : \textit{checkDisponibilite()}, \textit{annuler()}.
    \item \textbf{Facture :} Ajout de l'attribut \textit{assistantCreateur} (ManyToOne avec User nullable) pour distinguer les factures créées par assistant vs médecin.
    \item \textbf{User :} Ajout de l'énumération \textit{Role} avec valeurs \{MEDECIN, ASSISTANT, PATIENT\}. Ajout de méthodes de contrôle d'accès : \textit{canAccessDossiers()}, \textit{canManageAssistants()}, \textit{canAccessRapportsFinanciers()}.
    \item \textbf{EmailService :} Nouvelle classe de service pour l'envoi d'emails automatiques. Méthodes : \textit{sendRendezVousConfirmation(Patient, RendezVous)}, \textit{sendRendezVousAnnulation(Patient, RendezVous)}.
    \end{spacing}
\end{itemize}

\section{Réalisation}
Cette section présente les captures d'écran des principales fonctionnalités développées pour l'espace assistant.

\subsection{Authentification}

\textbf{Figure 4.5 : Page de connexion assistant}
\begin{figure}[H]%
    \center%
    \setlength{\fboxsep}{5pt}%
    \setlength{\fboxrule}{0.5pt}%
    \includegraphics[width=14cm,height=10cm]{images/login-assistant.png}%
    \caption{Page de connexion identique pour tous les utilisateurs (médecin/assistant/patient)}%
\end{figure}

\subsection{Tableau de bord assistant}

\textbf{Figure 4.6 : Dashboard assistant avec menu restreint}
\begin{figure}[H]%
    \center%
    \setlength{\fboxsep}{5pt}%
    \setlength{\fboxrule}{0.5pt}%
    \includegraphics[width=16cm,height=11cm]{images/dashboard-assistant.png}%
    \caption{Dashboard assistant avec menu latéral restreint (Patients, Rendez-vous, Factures uniquement)}%
\end{figure}

\subsection{Gestion des patients}

\textbf{Figure 4.7 : Liste des patients}
\begin{figure}[H]%
    \center%
    \setlength{\fboxsep}{5pt}%
    \setlength{\fboxrule}{0.5pt}%
    \includegraphics[width=16cm,height=10cm]{images/liste-patients-assistant.png}%
    \caption{Liste des patients avec nom, prénom, téléphone, email et actions (consulter, modifier)}%
\end{figure}

\textbf{Figure 4.8 : Formulaire de création de patient}
\begin{figure}[H]%
    \center%
    \setlength{\fboxsep}{5pt}%
    \setlength{\fboxrule}{0.5pt}%
    \includegraphics[width=14cm,height=12cm]{images/creer-patient-assistant.png}%
    \caption{Formulaire avec champs nom, prénom, date de naissance, téléphone, email, adresse}%
\end{figure}

\subsection{Gestion des rendez-vous}

\textbf{Figure 4.9 : Calendrier de rendez-vous}
\begin{figure}[H]%
    \center%
    \setlength{\fboxsep}{5pt}%
    \setlength{\fboxrule}{0.5pt}%
    \includegraphics[width=16cm,height=12cm]{images/calendrier-assistant.png}%
    \caption{Calendrier hebdomadaire avec rendez-vous, vérification automatique des conflits}%
\end{figure}

\textbf{Figure 4.10 : Création de rendez-vous avec vérification disponibilité}
\begin{figure}[H]%
    \center%
    \setlength{\fboxsep}{5pt}%
    \setlength{\fboxrule}{0.5pt}%
    \includegraphics[width=15cm,height=12cm]{images/creer-rendezvous-assistant.png}%
    \caption{Formulaire de création avec sélection patient, date, horaires et motif + vérification temps réel de disponibilité}%
\end{figure}

\textbf{Figure 4.11 : Notification de conflit horaire}
\begin{figure}[H]%
    \center%
    \setlength{\fboxsep}{5pt}%
    \setlength{\fboxrule}{0.5pt}%
    \includegraphics[width=13cm,height=8cm]{images/conflit-rendezvous.png}%
    \caption{Message d'erreur affiché lorsque le créneau sélectionné est déjà occupé}%
\end{figure}

\subsection{Gestion des factures (restreint)}

\textbf{Figure 4.12 : Liste des factures en lecture seule}
\begin{figure}[H]%
    \center%
    \setlength{\fboxsep}{5pt}%
    \setlength{\fboxrule}{0.5pt}%
    \includegraphics[width=16cm,height=10cm]{images/liste-factures-assistant.png}%
    \caption{Liste des factures avec numéro, patient, montant, statut - SANS boutons modifier/supprimer/payer}%
\end{figure}

\textbf{Figure 4.13 : Création de facture}
\begin{figure}[H]%
    \center%
    \setlength{\fboxsep}{5pt}%
    \setlength{\fboxrule}{0.5pt}%
    \includegraphics[width=14cm,height=10cm]{images/creer-facture-assistant.png}%
    \caption{Formulaire de création de facture accessible à l'assistant}%
\end{figure}

\subsection{Contrôle d'accès RBAC}

\textbf{Figure 4.14 : Tentative d'accès interdit}
\begin{figure}[H]%
    \center%
    \setlength{\fboxsep}{5pt}%
    \setlength{\fboxrule}{0.5pt}%
    \includegraphics[width=14cm,height=9cm]{images/acces-interdit-assistant.png}%
    \caption{Message d'erreur affiché lorsque l'assistant tente d'accéder aux dossiers médicaux}%
\end{figure}

\section{Implémentation du contrôle d'accès (RBAC)}

L'une des fonctionnalités clés de ce sprint est le système de contrôle d'accès basé sur les rôles (RBAC - Role-Based Access Control). Cette section détaille l'implémentation technique de ce système.

\subsection{Backend - Spring Security}

Le backend utilise Spring Security avec JWT pour implémenter le RBAC. Voici les principaux composants :

\textbf{Configuration des endpoints protégés :}
\begin{verbatim}
@EnableWebSecurity
public class SecurityConfig {
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) {
        http.authorizeHttpRequests(auth -> auth
            .requestMatchers("/api/auth/**").permitAll()
            .requestMatchers("/api/dossiers/**").hasRole("MEDECIN")
            .requestMatchers("/api/assistants/**").hasRole("MEDECIN")
            .requestMatchers("/api/rapports/**").hasRole("MEDECIN")
            .requestMatchers("/api/factures/*/paiement").hasRole("MEDECIN")
            .requestMatchers("/api/patients/**").hasAnyRole("MEDECIN", "ASSISTANT")
            .requestMatchers("/api/rendezvous/**").hasAnyRole("MEDECIN", "ASSISTANT")
            .requestMatchers("/api/factures").hasAnyRole("MEDECIN", "ASSISTANT")
            .anyRequest().authenticated()
        );
    }
}
\end{verbatim}

\textbf{Annotations sur les contrôleurs :}
\begin{verbatim}
@RestController
@RequestMapping("/api/dossiers")
@PreAuthorize("hasRole('MEDECIN')")
public class DossierController {
    // Accessible uniquement par le médecin
}

@RestController
@RequestMapping("/api/factures")
public class FactureController {
    @PostMapping
    @PreAuthorize("hasAnyRole('MEDECIN', 'ASSISTANT')")
    public Facture creerFacture(@RequestBody Facture facture) {
        // Création autorisée pour médecin ET assistant
    }
    
    @PutMapping("/{id}/paiement")
    @PreAuthorize("hasRole('MEDECIN')")
    public Facture enregistrerPaiement(@PathVariable Long id, ...) {
        // Paiement autorisé uniquement pour le médecin
    }
}
\end{verbatim}

\subsection{Frontend - Next.js}

Le frontend implémente également des contrôles pour améliorer l'expérience utilisateur et éviter les requêtes inutiles :

\textbf{RoleGuard Component :}
\begin{verbatim}
export function RoleGuard({ children, allowedRoles }) {
    const { user } = useAuth();
    if (!user || !allowedRoles.includes(user.role)) {
        return <AccessDenied />;
    }
    return <>{children}</>;
}
\end{verbatim}

\textbf{Affichage conditionnel des menus :}
\begin{verbatim}
{user.role === 'MEDECIN' && (
    <>
        <NavItem href="/dashboard/dossiers">Dossiers Médicaux</NavItem>
        <NavItem href="/dashboard/assistants">Assistants</NavItem>
        <NavItem href="/dashboard/rapports">Rapports Financiers</NavItem>
    </>
)}
\end{verbatim}

\section{CONCLUSION}
Ce chapitre a présenté la réalisation du sprint 2 focalisé sur l'espace assistant avec un système robuste de contrôle d'accès basé sur les rôles (RBAC). Nous avons développé les fonctionnalités essentielles permettant aux assistants de gérer les patients (création, modification, consultation), de planifier les rendez-vous avec vérification automatique de disponibilité et notifications par email, et de créer des factures avec restrictions strictes.

L'implémentation du RBAC garantit la sécurité et la confidentialité des données médicales en interdisant aux assistants l'accès aux dossiers médicaux, documents médicaux, rapports financiers et gestion d'autres assistants. Cette architecture de sécurité multi-niveaux (backend + frontend) offre une protection robuste contre les accès non autorisés.

Le prochain chapitre détaillera le sprint 3 dédié à l'espace patient, avec inscription sécurisée par email, consultation de dossiers médicaux, téléchargement de documents et interaction avec le chatbot d'intelligence artificielle.
