\chapter{CHAPITRE 5 : \textbf{Sprint 3 - Gestion de l'espace Patient et Chatbot IA}}
\begin{spacing}{1.2}
\minitoc
\thispagestyle{MyStyle}
\end{spacing}
\newpage

\section{INTRODUCTION}
Dans ce chapitre, nous présentons le troisième et dernier sprint intitulé "Gestion de l'espace Patient et Chatbot IA". Après avoir développé les espaces médecin (sprint 1) et assistant (sprint 2), nous nous concentrons maintenant sur l'interface destinée aux patients, avec une fonctionnalité innovante d'intelligence artificielle. Ce sprint permet aux patients de s'inscrire de manière sécurisée, de consulter leurs dossiers médicaux, de télécharger leurs documents et d'interagir avec un chatbot médical intelligent utilisant l'API OpenAI. Nous allons commencer par la présentation du backlog du sprint 3, suivie de la spécification fonctionnelle, de la conception avec diagrammes UML, et enfin nous illustrerons les fonctionnalités développées à travers des captures d'écran.

\section{Backlog du sprint 3}
Le tableau \ref{tableau:Backlog du sprint 3} présente l'ensemble des user stories sélectionnées pour le sprint 3, focalisées sur l'espace patient et le chatbot IA.

\begin{longtable}{|p{3.5cm}|p{9cm}|p{1.5cm}|p{2cm}|}
\caption{Backlog du sprint 3 - Espace Patient et Chatbot IA}
\label{tableau:Backlog du sprint 3}
\\
\hline
 \cellcolor[HTML]{FFF2CC}Fonctionnalités  
& \cellcolor[HTML]{FFF2CC}User Stories   
& \cellcolor[HTML]{FFF2CC}Priorités
& \cellcolor[HTML]{FFF2CC}Estimation\\
\hline
\endfirsthead
\hline
 \cellcolor[HTML]{FFF2CC}Fonctionnalités  
& \cellcolor[HTML]{FFF2CC}User Stories   
& \cellcolor[HTML]{FFF2CC}Priorités
& \cellcolor[HTML]{FFF2CC}Estimation\\
\hline
\endhead
\multirow{3}{10em}{Inscription Sécurisée}
& En tant que patient, je veux m'inscrire avec email, nom, prénom et mot de passe & Élevée & 4 jours
\\\cline{2-4}
& En tant que patient, je veux recevoir un email de vérification après inscription & Élevée & 2 jours
\\\cline{2-4}
& En tant que patient, je veux cliquer sur le lien de vérification pour activer mon compte & Élevée & 2 jours
\\ \hline
\multirow{2}{10em}{Authentification}
& En tant que patient, je veux m'authentifier pour accéder à mon espace personnel & Élevée & 2 jours
\\\cline{2-4}
& En tant que patient, je veux me déconnecter pour quitter ma session en toute sécurité & Moyenne & 1 jour
\\ \hline
\multirow{3}{8em}{Gestion Rendez-vous}
& En tant que patient, je veux prendre un rendez-vous en ligne avec sélection de date et créneau & Élevée & 5 jours
\\\cline{2-4}
& En tant que patient, je veux consulter mes prochains rendez-vous avec détails (date, médecin, motif) & Élevée & 3 jours
\\\cline{2-4}
& En tant que patient, je veux annuler un rendez-vous si nécessaire & Moyenne & 2 jours
\\ \hline
\multirow{4}{8em}{Consultation Dossiers Médicaux}
& En tant que patient, je veux consulter l'historique complet de mes dossiers médicaux & Élevée & 4 jours
\\\cline{2-4}
& En tant que patient, je veux voir les détails de chaque dossier (diagnostic, traitement, notes, allergies, antécédents) & Élevée & 3 jours
\\\cline{2-4}
& En tant que patient, je veux consulter la liste des documents associés à chaque dossier & Moyenne & 2 jours
\\\cline{2-4}
& En tant que patient, je veux télécharger mes documents médicaux (ordonnances, analyses) en format PDF & Élevée & 3 jours
\\ \hline
\multirow{4}{8em}{Chatbot Intelligence Artificielle}
& En tant que patient, je veux accéder à un chatbot médical pour poser des questions générales & Élevée & 5 jours
\\\cline{2-4}
& En tant que patient, je veux recevoir des réponses intelligentes basées sur l'IA (OpenAI API) & Élevée & 4 jours
\\\cline{2-4}
& En tant que patient, je veux que le chatbot me rappelle de consulter un médecin pour les questions critiques & Moyenne & 2 jours
\\ \hline
\multirow{2}{8em}{Gestion Profil}
& En tant que patient, je veux consulter mes informations personnelles (nom, email, téléphone) & Moyenne & 2 jours
\\\cline{2-4}
& En tant que patient, je veux modifier mes informations personnelles (sauf données médicales) & Moyenne & 2 jours
\\ \hline
\end{longtable}

Chaque user story représente une fonctionnalité que le patient souhaite pouvoir réaliser dans le système. Les priorités sont classées en élevée, moyenne ou faible, reflétant l'importance relative de chaque user story. Le chatbot d'intelligence artificielle constitue l'innovation majeure de ce sprint, offrant une assistance médicale virtuelle accessible 24/7.

\section{Spécifications fonctionnelles}
Dans cette partie, nous présentons le diagramme de cas d'utilisation du sprint 3 ainsi que les descriptions textuelles détaillées.

\subsection{Diagramme de cas d'utilisation du sprint 3}
Le diagramme de cas d'utilisation du sprint 3, présenté dans la figure 5.1, illustre les besoins fonctionnels sous la forme d'interactions entre le patient et le système, incluant le chatbot IA.

\begin{figure}[H]%
    \center%
    \setlength{\fboxsep}{5pt}%
    \setlength{\fboxrule}{0.5pt}%
    \includegraphics[width=14cm,height=13cm]{images/sprint3-patient-usecase.png}%
    \caption{Diagramme de cas d'utilisation du sprint 3 - Espace Patient}%
\end{figure}

\subsection{Descriptions textuelles}
L'objectif de cette activité est de décrire textuellement les scénarios des cas d'utilisation. Il faut préciser comment chaque scénario commence, comment il se termine et comment le patient interagit avec l'application web.

\textbf{Description textuelle du cas d'utilisation "S'inscrire - Patient" :}\\
Le tableau \ref{tableau:Description textuelle du cas d'utilisation "S'inscrire - Patient"} présente la description textuelle du cas d'utilisation "S'inscrire". Ce scénario permet à un nouveau patient de créer son compte avec vérification par email.

\begin{longtable}{|p{5cm}|p{10cm}|}
\caption{Description textuelle du cas d'utilisation "S'inscrire - Patient"}
\label{tableau:Description textuelle du cas d'utilisation "S'inscrire - Patient"}
\\
\hline
\cellcolor[HTML]{FFF2CC}Cas d'utilisation  
& \cellcolor[HTML]{FFF2CC}S'inscrire - Patient\\
\hline
\endfirsthead
\hline
\cellcolor[HTML]{FFF2CC}Cas d'utilisation  
& \cellcolor[HTML]{FFF2CC}S'inscrire - Patient\\
\hline
\endhead
Acteur & Patient (nouveau)
\\ \hline
Précondition & 
\begin{enumerate}
    \item Le système est en service.
    \item Le patient ne possède pas encore de compte.
    \item Le patient accède à la page publique d'inscription /register.
\end{enumerate}
\\ \hline
Post-condition & 
\begin{enumerate}
    \item Un compte patient est créé avec le statut "NON\_VERIFIE".
    \item Le mot de passe est hashé avec BCrypt avant stockage.
    \item Un email de vérification contenant un token unique est envoyé à l'adresse email du patient.
    \item Le patient doit cliquer sur le lien de vérification pour activer son compte.
\end{enumerate}
\\ \hline
Scénario principal & 
\begin{enumerate}
    \item Le patient accède à la page d'inscription (/register).
    \item Le système affiche le formulaire d'inscription avec les champs : email, nom, prénom, mot de passe, confirmation mot de passe.
    \item Le patient remplit tous les champs obligatoires.
    \item Le patient clique sur "S'inscrire".
    \item Le système valide les données saisies (format email, force mot de passe, correspondance des mots de passe).
    \item Le système vérifie que l'email correspond à un patient existant via GET /api/patients/check-email.
    \item Le système envoie une requête POST /api/auth/register avec les données.
    \item Le backend vérifie que l'email n'a pas déjà un compte associé.
    \item Le backend hash le mot de passe avec BCrypt.
    \item Le backend génère un token de vérification unique (UUID).
    \item Le backend enregistre le compte avec statut "NON\_VERIFIE" et le token.
    \item Le backend envoie un email contenant le lien de vérification : https://cabinet.com/verify?token=XXXXX.
    \item Le système affiche un message "Un email de vérification a été envoyé à votre adresse. Veuillez cliquer sur le lien pour activer votre compte".
\end{enumerate}
\\ \hline
Scénario alternatif & 
\begin{enumerate}
    \item Le patient laisse des champs obligatoires vides \(\rightarrow\) affichage d'erreurs de validation.
    \item Le format de l'email est invalide \(\rightarrow\) affichage d'un message "Email invalide".
    \item Les mots de passe ne correspondent pas \(\rightarrow\) affichage d'un message "Les mots de passe ne correspondent pas".
    \item Le mot de passe est trop faible (moins de 8 caractères) \(\rightarrow\) affichage d'un message "Le mot de passe doit contenir au moins 8 caractères".
    \item L'email ne correspond à aucun patient enregistré \(\rightarrow\) affichage d'un message "Aucun patient trouvé avec cet email. Contactez le cabinet".
    \item L'email possède déjà un compte actif \(\rightarrow\) affichage d'un message "Un compte existe déjà avec cet email. Connectez-vous".
    \item Erreur d'envoi d'email \(\rightarrow\) affichage d'un message "Erreur lors de l'envoi de l'email de vérification, veuillez réessayer".
\end{enumerate}
\\\hline
\end{longtable}

\textbf{Description textuelle du cas d'utilisation "Vérifier Email" :}\\
Le tableau \ref{tableau:Description textuelle du cas d'utilisation "Vérifier Email"} présente la description textuelle du cas d'utilisation "Vérifier Email". Ce scénario active le compte patient après clic sur le lien de vérification.

\begin{longtable}{|p{5cm}|p{10cm}|}
\caption{Description textuelle du cas d'utilisation "Vérifier Email"}
\label{tableau:Description textuelle du cas d'utilisation "Vérifier Email"}
\\
\hline
\cellcolor[HTML]{FFF2CC}Cas d'utilisation  
& \cellcolor[HTML]{FFF2CC}Vérifier Email\\
\hline
\endfirsthead
\hline
\cellcolor[HTML]{FFF2CC}Cas d'utilisation  
& \cellcolor[HTML]{FFF2CC}Vérifier Email\\
\hline
\endhead
Acteur & Patient (non vérifié)
\\ \hline
Précondition & 
\begin{enumerate}
    \item Le patient a créé un compte avec le statut "NON\_VERIFIE".
    \item Le patient a reçu un email avec un lien de vérification contenant un token unique.
\end{enumerate}
\\ \hline
Post-condition & 
\begin{enumerate}
    \item Le statut du compte passe de "NON\_VERIFIE" à "VERIFIE".
    \item Le token de vérification est marqué comme utilisé.
    \item Le patient peut se connecter à son espace personnel.
\end{enumerate}
\\ \hline
Scénario principal & 
\begin{enumerate}
    \item Le patient clique sur le lien de vérification dans l'email reçu.
    \item Le navigateur ouvre l'URL /verify?token=XXXXX.
    \item Le système extrait le token de l'URL.
    \item Le système envoie une requête GET /api/auth/verify?token=XXXXX.
    \item Le backend recherche le compte associé au token.
    \item Le backend vérifie que le token n'a pas expiré (validité 24h).
    \item Le backend met à jour le statut du compte à "VERIFIE".
    \item Le backend marque le token comme utilisé.
    \item Le système affiche un message de succès "Votre compte a été vérifié avec succès. Vous pouvez maintenant vous connecter".
    \item Le système redirige automatiquement vers /login après 3 secondes.
\end{enumerate}
\\ \hline
Scénario alternatif & 
\begin{enumerate}
    \item Le token est invalide (n'existe pas en base) \(\rightarrow\) affichage d'un message "Lien de vérification invalide".
    \item Le token a expiré (> 24h) \(\rightarrow\) affichage d'un message "Le lien de vérification a expiré. Veuillez vous réinscrire".
    \item Le token a déjà été utilisé \(\rightarrow\) affichage d'un message "Ce compte a déjà été vérifié. Connectez-vous".
    \item Erreur serveur lors de la vérification \(\rightarrow\) affichage d'un message "Erreur lors de la vérification, veuillez réessayer".
\end{enumerate}
\\\hline
\end{longtable}

\textbf{Description textuelle du cas d'utilisation "Consulter Dossiers Médicaux" :}\\
Le tableau \ref{tableau:Description textuelle du cas d'utilisation "Consulter Dossiers Médicaux - Patient"} présente la description textuelle du cas d'utilisation "Consulter Dossiers Médicaux". Ce scénario permet au patient de consulter son historique médical complet.

\begin{longtable}{|p{5cm}|p{10cm}|}
\caption{Description textuelle du cas d'utilisation "Consulter Dossiers Médicaux - Patient"}
\label{tableau:Description textuelle du cas d'utilisation "Consulter Dossiers Médicaux - Patient"}
\\
\hline
\cellcolor[HTML]{FFF2CC}Cas d'utilisation  
& \cellcolor[HTML]{FFF2CC}Consulter Dossiers Médicaux\\
\hline
\endfirsthead
\hline
\cellcolor[HTML]{FFF2CC}Cas d'utilisation  
& \cellcolor[HTML]{FFF2CC}Consulter Dossiers Médicaux\\
\hline
\endhead
Acteur & Patient
\\ \hline
Précondition & 
\begin{enumerate}
    \item Le patient est authentifié avec un compte vérifié.
    \item Au moins un dossier médical existe pour ce patient.
\end{enumerate}
\\ \hline
Post-condition & 
\begin{enumerate}
    \item Le patient visualise l'historique complet de ses dossiers médicaux triés par date décroissante.
    \item Le patient consulte les détails de chaque dossier : diagnostic, traitement, notes, allergies, antécédents.
    \item Le patient consulte la liste des documents associés à chaque dossier.
\end{enumerate}
\\ \hline
Scénario principal & 
\begin{enumerate}
    \item Le patient accède à la section "Mes Dossiers Médicaux" (/dashboard/patient/dossiers).
    \item Le système envoie une requête GET /api/patients/{patientId}/dossiers.
    \item Le backend vérifie que le patient authentifié demande bien SES propres dossiers (vérification ID JWT = ID patient).
    \item Le backend récupère tous les dossiers médicaux associés au patient.
    \item Le système affiche la liste chronologique des dossiers (du plus récent au plus ancien).
    \item Le patient sélectionne un dossier dans la liste.
    \item Le système affiche les détails complets du dossier dans un panneau déroulant ou modal.
    \item Le patient consulte les informations : date de création, diagnostic, traitement prescrit, notes cliniques, allergies identifiées, antécédents médicaux.
    \item Le patient consulte la liste des documents uploadés (ordonnances, analyses).
\end{enumerate}
\\ \hline
Scénario alternatif & 
\begin{enumerate}
    \item Aucun dossier médical n'existe pour ce patient \(\rightarrow\) affichage d'un message "Aucun dossier médical disponible".
    \item Le patient tente d'accéder aux dossiers d'un autre patient en modifiant l'URL \(\rightarrow\) erreur 403 Forbidden "Accès non autorisé".
    \item Erreur serveur lors de la récupération des dossiers \(\rightarrow\) affichage d'un message "Erreur lors de la récupération des dossiers, veuillez réessayer".
\end{enumerate}
\\\hline
\end{longtable}

\textbf{Description textuelle du cas d'utilisation "Télécharger Document Médical" :}\\
Le tableau \ref{tableau:Description textuelle du cas d'utilisation "Télécharger Document"} présente la description textuelle du cas d'utilisation "Télécharger Document Médical". Ce scénario permet au patient de télécharger ses ordonnances et résultats d'analyses.

\begin{longtable}{|p{5cm}|p{10cm}|}
\caption{Description textuelle du cas d'utilisation "Télécharger Document Médical"}
\label{tableau:Description textuelle du cas d'utilisation "Télécharger Document"}
\\
\hline
\cellcolor[HTML]{FFF2CC}Cas d'utilisation  
& \cellcolor[HTML]{FFF2CC}Télécharger Document Médical\\
\hline
\endfirsthead
\hline
\cellcolor[HTML]{FFF2CC}Cas d'utilisation  
& \cellcolor[HTML]{FFF2CC}Télécharger Document Médical\\
\hline
\endhead
Acteur & Patient
\\ \hline
Précondition & 
\begin{enumerate}
    \item Le patient est authentifié avec un compte vérifié.
    \item Le patient consulte un dossier médical contenant des documents.
\end{enumerate}
\\ \hline
Post-condition & 
\begin{enumerate}
    \item Le fichier (ordonnance, analyse) est téléchargé sur l'ordinateur du patient en format PDF/JPG/PNG.
    \item Le téléchargement est tracé dans les logs système pour audit.
\end{enumerate}
\\ \hline
Scénario principal & 
\begin{enumerate}
    \item Le patient consulte un dossier médical avec des documents associés.
    \item Le système affiche la liste des documents avec nom de fichier et type (Ordonnance, Analyse, Imagerie).
    \item Le patient clique sur le bouton "Télécharger" à côté d'un document.
    \item Le système envoie une requête GET /api/documents/{documentId}/download.
    \item Le backend vérifie que le document appartient bien à un dossier du patient authentifié.
    \item Le backend récupère le fichier depuis le système de fichiers (uploads/dossier-{id}/).
    \item Le backend envoie le fichier au frontend avec les headers appropriés (Content-Type, Content-Disposition: attachment).
    \item Le navigateur télécharge automatiquement le fichier.
    \item Le système enregistre un log : "Patient {id} a téléchargé le document {documentId} le {date}".
\end{enumerate}
\\ \hline
Scénario alternatif & 
\begin{enumerate}
    \item Le patient tente de télécharger un document d'un autre patient \(\rightarrow\) erreur 403 Forbidden "Accès non autorisé".
    \item Le fichier n'existe plus sur le système de fichiers \(\rightarrow\) affichage d'un message "Fichier introuvable, contactez le cabinet".
    \item Erreur serveur lors du téléchargement \(\rightarrow\) affichage d'un message "Erreur lors du téléchargement, veuillez réessayer".
\end{enumerate}
\\\hline
\end{longtable}

\textbf{Description textuelle du cas d'utilisation "Interagir avec Chatbot IA" :}\\
Le tableau \ref{tableau:Description textuelle du cas d'utilisation "Chatbot IA"} présente la description textuelle du cas d'utilisation "Interagir avec Chatbot IA". Ce scénario permet au patient de poser des questions médicales générales à un assistant virtuel intelligent.

\begin{longtable}{|p{5cm}|p{10cm}|}
\caption{Description textuelle du cas d'utilisation "Interagir avec Chatbot IA"}
\label{tableau:Description textuelle du cas d'utilisation "Chatbot IA"}
\\
\hline
\cellcolor[HTML]{FFF2CC}Cas d'utilisation  
& \cellcolor[HTML]{FFF2CC}Interagir avec Chatbot IA\\
\hline
\endfirsthead
\hline
\cellcolor[HTML]{FFF2CC}Cas d'utilisation  
& \cellcolor[HTML]{FFF2CC}Interagir avec Chatbot IA\\
\hline
\endhead
Acteur & Patient
\\ \hline
Précondition & 
\begin{enumerate}
    \item Le patient est authentifié avec un compte vérifié.
    \item Le backend a accès à l'API OpenAI (clé API configurée).
\end{enumerate}
\\ \hline
Post-condition & 
\begin{enumerate}
    \item Le patient reçoit une réponse générée par l'IA (OpenAI GPT-4) à sa question médicale.
    \item L'historique de la conversation est sauvegardé en base de données.
    \item Le patient peut consulter l'historique complet de ses conversations avec le chatbot.
\end{enumerate}
\\ \hline
Scénario principal & 
\begin{enumerate}
    \item Le patient accède à la section "Chatbot Médical" (/dashboard/patient/chatbot).
    \item Le système affiche une interface de chat avec historique des conversations précédentes.
    \item Le patient saisit une question médicale dans le champ de texte (ex: "Quels sont les symptômes de la grippe ?").
    \item Le patient clique sur "Envoyer" ou appuie sur Entrée.
    \item Le système affiche le message du patient dans le chat avec horodatage.
    \item Le système envoie une requête POST /api/chatbot/message avec le texte de la question.
    \item Le backend ajoute un contexte système à la requête OpenAI : "Tu es un assistant médical virtuel. Réponds aux questions médicales générales de manière claire. Pour les symptômes graves, recommande toujours de consulter un médecin.".
    \item Le backend appelle l'API OpenAI (modèle GPT-4) avec la question + contexte.
    \item L'API OpenAI génère une réponse intelligente et contextuelle.
    \item Le backend sauvegarde la conversation en base : {patientId, question, réponse, timestamp}.
    \item Le backend retourne la réponse au frontend.
    \item Le système affiche la réponse du chatbot dans le chat avec horodatage.
    \item Le patient peut continuer la conversation en posant une nouvelle question.
\end{enumerate}
\\ \hline
Scénario alternatif & 
\begin{enumerate}
    \item Le patient saisit une question vide \(\rightarrow\) affichage d'un message "Veuillez saisir une question".
    \item La question contient des mots-clés critiques (douleur thoracique, difficulté respiratoire, saignement important) \(\rightarrow\) le chatbot répond avec un avertissement : "Vos symptômes nécessitent une consultation médicale urgente. Contactez immédiatement un médecin ou les urgences".
    \item Erreur API OpenAI (quota dépassé, service indisponible) \(\rightarrow\) affichage d'un message "Le chatbot est temporairement indisponible, veuillez réessayer plus tard".
    \item Timeout de l'API OpenAI (> 30 secondes) \(\rightarrow\) affichage d'un message "Le chatbot met trop de temps à répondre, veuillez réessayer".
\end{enumerate}
\\\hline
\end{longtable}

\section{Conception}
Dans cette section, nous présentons les diagrammes de conception du sprint 3, notamment les diagrammes de séquence et l'architecture du chatbot IA.

\subsection{Diagrammes de séquence}

\textbf{Diagramme de séquence "Inscription avec Vérification Email" :}\\
La figure 5.2 illustre le diagramme de séquence complet du processus d'inscription sécurisée avec vérification par email.

\begin{figure}[H]%
    \center%
    \setlength{\fboxsep}{5pt}%
    \setlength{\fboxrule}{0.5pt}%
    \includegraphics[width=16cm,height=14cm]{images/sequence-inscription-patient.png}%
    \caption{Diagramme de séquence - Inscription Patient avec Vérification Email}%
\end{figure}

\textbf{Diagramme de séquence "Interaction avec Chatbot OpenAI" :}\\
La figure 5.3 illustre le diagramme de séquence montrant l'interaction entre le patient, le frontend, l'API backend et l'API OpenAI pour le chatbot.

\begin{figure}[H]%
    \center%
    \setlength{\fboxsep}{5pt}%
    \setlength{\fboxrule}{0.5pt}%
    \includegraphics[width=16cm,height=14cm]{images/sequence-chatbot-openai.png}%
    \caption{Diagramme de séquence - Interaction Chatbot IA}%
\end{figure}

\subsection{Architecture du Chatbot IA}

Le chatbot médical repose sur une architecture moderne intégrant l'API OpenAI :

\begin{figure}[H]%
    \center%
    \setlength{\fboxsep}{5pt}%
    \setlength{\fboxrule}{0.5pt}%
    \includegraphics[width=15cm,height=11cm]{images/architecture-chatbot.png}%
    \caption{Architecture du Chatbot avec OpenAI API}%
\end{figure}

\textbf{Composants de l'architecture :}

\begin{itemize}[leftmargin=2cm, topsep=0pt]
    \begin{spacing}{1.25}
    \item \textbf{Frontend (Next.js) :} Interface de chat interactive avec affichage en temps réel des messages, zone de saisie, historique des conversations.
    \item \textbf{Backend (Spring Boot) :} API REST exposant l'endpoint POST /api/chatbot/message, gestion de l'authentification JWT, sauvegarde des conversations en base.
    \item \textbf{OpenAI Service :} Classe Java gérant les appels à l'API OpenAI, formatage des requêtes avec contexte système, gestion des erreurs et timeouts.
    \item \textbf{OpenAI API :} Service externe (GPT-4) analysant les questions et générant des réponses médicales intelligentes.
    \item \textbf{Base de données :} Table ConversationChatbot stockant {id, patientId, question, réponse, timestamp} pour traçabilité et historique.
    \end{spacing}
\end{itemize}

\textbf{Prompt système envoyé à OpenAI :}
\begin{verbatim}
Vous êtes un assistant médical virtuel pour un cabinet médical. 
Votre rôle est de répondre aux questions médicales générales 
des patients de manière claire, précise et bienveillante.

RÈGLES IMPORTANTES :
1. Pour les questions générales (symptômes communs, prévention, 
   hygiène), fournissez des informations claires et pédagogiques.
2. Pour les symptômes graves (douleur thoracique, difficulté 
   respiratoire, saignement important), recommandez TOUJOURS 
   une consultation médicale urgente.
3. Ne posez JAMAIS de diagnostic médical précis.
4. Encouragez toujours la consultation avec un médecin pour 
   un avis personnalisé.
5. Restez dans le domaine médical général, n'abordez pas 
   de sujets hors contexte.

Question du patient : [QUESTION]
\end{verbatim}

\subsection{Diagramme de classes du sprint 3}

Le diagramme de classes du sprint 3, présenté dans la figure 5.5, illustre les nouvelles entités liées à l'espace patient et au chatbot.

\begin{figure}[H]%
    \center%
    \setlength{\fboxsep}{5pt}%
    \setlength{\fboxrule}{0.5pt}%
    \includegraphics[width=16cm,height=14cm]{images/class-diagram-sprint3.png}%
    \caption{Diagramme de classes - Sprint 3}%
\end{figure}

\textbf{Nouvelles classes pour le Sprint 3 :}

\begin{itemize}[leftmargin=2cm, topsep=0pt]
    \begin{spacing}{1.25}
    \item \textbf{Patient (étendu) :} Ajout des attributs \textit{emailVerifie} (boolean), \textit{tokenVerification} (String UUID), \textit{dateTokenExpiration} (DateTime). Ajout de la méthode \textit{verifierEmail(token)}.
    \item \textbf{ConversationChatbot :} Nouvelle entité avec attributs id, patientId (ManyToOne), question (Text), réponse (Text), timestamp (DateTime). Représente l'historique des interactions avec le chatbot.
    \item \textbf{Document (étendu) :} Ajout de la méthode \textit{download()} pour tracer les téléchargements.
    \item \textbf{OpenAIService :} Nouvelle classe de service avec méthodes \textit{sendQuestion(question, context)}, \textit{parseResponse(apiResponse)}, \textit{handleErrors()}.
    \end{spacing}
\end{itemize}

\section{Réalisation}
Cette section présente les captures d'écran des principales fonctionnalités développées pour l'espace patient.

\subsection{Inscription et vérification}

\textbf{Figure 5.6 : Page d'inscription patient}
\begin{figure}[H]%
    \center%
    \setlength{\fboxsep}{5pt}%
    \setlength{\fboxrule}{0.5pt}%
    \includegraphics[width=14cm,height=11cm]{images/inscription-patient.png}%
    \caption{Formulaire d'inscription avec email, nom, prénom, mot de passe, confirmation}%
\end{figure}

\textbf{Figure 5.7 : Email de vérification}
\begin{figure}[H]%
    \center%
    \setlength{\fboxsep}{5pt}%
    \setlength{\fboxrule}{0.5pt}%
    \includegraphics[width=14cm,height=10cm]{images/email-verification.png}%
    \caption{Email envoyé au patient avec lien de vérification unique}%
\end{figure}

\textbf{Figure 5.8 : Page de confirmation de vérification}
\begin{figure}[H]%
    \center%
    \setlength{\fboxsep}{5pt}%
    \setlength{\fboxrule}{0.5pt}%
    \includegraphics[width=14cm,height=9cm]{images/verification-succes.png}%
    \caption{Message de succès après vérification, redirection automatique vers login}%
\end{figure}

\subsection{Tableau de bord patient}

\textbf{Figure 5.9 : Dashboard patient}
\begin{figure}[H]%
    \center%
    \setlength{\fboxsep}{5pt}%
    \setlength{\fboxrule}{0.5pt}%
    \includegraphics[width=16cm,height=11cm]{images/dashboard-patient.png}%
    \caption{Dashboard avec menu latéral (Mes Dossiers, Chatbot Médical, Profil)}%
\end{figure}

\subsection{Consultation de dossiers médicaux}

\textbf{Figure 5.10 : Liste des dossiers médicaux}
\begin{figure}[H]%
    \center%
    \setlength{\fboxsep}{5pt}%
    \setlength{\fboxrule}{0.5pt}%
    \includegraphics[width=16cm,height=12cm]{images/liste-dossiers-patient.png}%
    \caption{Historique chronologique des dossiers avec date, diagnostic, traitement}%
\end{figure}

\textbf{Figure 5.11 : Détails d'un dossier médical}
\begin{figure}[H]%
    \center%
    \setlength{\fboxsep}{5pt}%
    \setlength{\fboxrule}{0.5pt}%
    \includegraphics[width=16cm,height=13cm]{images/detail-dossier-patient.png}%
    \caption{Affichage complet : diagnostic, traitement, notes, allergies, antécédents, documents}%
\end{figure}

\textbf{Figure 5.12 : Téléchargement de document}
\begin{figure}[H]%
    \center%
    \setlength{\fboxsep}{5pt}%
    \setlength{\fboxrule}{0.5pt}%
    \includegraphics[width{15cm,height=10cm]{images/telechargement-document.png}%
    \caption{Liste des documents avec boutons de téléchargement (Ordonnance, Analyse)}%
\end{figure}

\subsection{Chatbot médical IA}

\textbf{Figure 5.13 : Interface du chatbot}
\begin{figure}[H]%
    \center%
    \setlength{\fboxsep}{5pt}%
    \setlength{\fboxrule}{0.5pt}%
    \includegraphics[width=15cm,height=13cm]{images/chatbot-interface.png}%
    \caption{Interface de chat avec historique des conversations et zone de saisie}%
\end{figure}

\textbf{Figure 5.14 : Conversation avec le chatbot}
\begin{figure}[H]%
    \center%
    \setlength{\fboxsep}{5pt}%
    \setlength{\fboxrule}{0.5pt}%
    \includegraphics[width=15cm,height=14cm]{images/chatbot-conversation.png}%
    \caption{Exemple de conversation : question sur symptômes de grippe avec réponse détaillée de l'IA}%
\end{figure}

\textbf{Figure 5.15 : Réponse critique du chatbot}
\begin{figure}[H]%
    \center%
    \setlength{\fboxsep}{5pt}%
    \setlength{\fboxrule}{0.5pt}%
    \includegraphics[width=15cm,height=11cm]{images/chatbot-alerte.png}%
    \caption{Réponse du chatbot pour symptômes graves : recommandation urgente de consulter un médecin}%
\end{figure}

\section{Implémentation technique du Chatbot}

Cette section détaille l'implémentation technique du chatbot avec intégration OpenAI.

\subsection{Backend - Service OpenAI}

\textbf{Classe OpenAIService.java :}
\begin{verbatim}
@Service
public class OpenAIService {
    @Value("${openai.api.key}")
    private String apiKey;
    
    private static final String API_URL = 
        "https://api.openai.com/v1/chat/completions";
    
    public String generateResponse(String question) {
        RestTemplate restTemplate = new RestTemplate();
        
        // Créer le contexte système
        String systemPrompt = "Vous êtes un assistant médical...";
        
        // Préparer la requête OpenAI
        Map<String, Object> request = Map.of(
            "model", "gpt-4",
            "messages", List.of(
                Map.of("role", "system", "content", systemPrompt),
                Map.of("role", "user", "content", question)
            ),
            "max_tokens", 500,
            "temperature", 0.7
        );
        
        // Headers avec API Key
        HttpHeaders headers = new HttpHeaders();
        headers.set("Authorization", "Bearer " + apiKey);
        headers.setContentType(MediaType.APPLICATION_JSON);
        
        HttpEntity<Map<String, Object>> entity = 
            new HttpEntity<>(request, headers);
        
        // Appel API OpenAI
        ResponseEntity<Map> response = restTemplate.exchange(
            API_URL, HttpMethod.POST, entity, Map.class);
        
        // Extraire la réponse
        Map<String, Object> body = response.getBody();
        List<Map<String, Object>> choices = 
            (List) body.get("choices");
        Map<String, Object> message = 
            (Map) choices.get(0).get("message");
        return (String) message.get("content");
    }
}
\end{verbatim}

\textbf{Contrôleur ChatbotController.java :}
\begin{verbatim}
@RestController
@RequestMapping("/api/chatbot")
public class ChatbotController {
    @Autowired
    private OpenAIService openAIService;
    
    @Autowired
    private ConversationRepository conversationRepo;
    
    @PostMapping("/message")
    @PreAuthorize("hasRole('PATIENT')")
    public ResponseEntity<Map<String, String>> sendMessage(
        @RequestBody Map<String, String> request,
        Authentication authentication) {
        
        String question = request.get("question");
        Long patientId = ((UserPrincipal) 
            authentication.getPrincipal()).getId();
        
        // Appeler OpenAI
        String response = openAIService.generateResponse(question);
        
        // Sauvegarder la conversation
        ConversationChatbot conversation = new ConversationChatbot();
        conversation.setPatientId(patientId);
        conversation.setQuestion(question);
        conversation.setReponse(response);
        conversation.setTimestamp(LocalDateTime.now());
        conversationRepo.save(conversation);
        
        return ResponseEntity.ok(Map.of("response", response));
    }
}
\end{verbatim}

\subsection{Frontend - Composant Chatbot}

\textbf{Composant ChatbotPage.tsx :}
\begin{verbatim}
export default function ChatbotPage() {
    const [messages, setMessages] = useState([]);
    const [input, setInput] = useState('');
    const [loading, setLoading] = useState(false);
    
    const sendMessage = async () => {
        if (!input.trim()) return;
        
        // Ajouter le message de l'utilisateur
        const userMessage = { role: 'user', content: input };
        setMessages([...messages, userMessage]);
        setInput('');
        setLoading(true);
        
        try {
            const response = await fetch('/api/chatbot/message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getToken()}`
                },
                body: JSON.stringify({ question: input })
            });
            
            const data = await response.json();
            
            // Ajouter la réponse du chatbot
            const botMessage = { 
                role: 'assistant', 
                content: data.response 
            };
            setMessages(prev => [...prev, botMessage]);
        } catch (error) {
            console.error('Erreur chatbot:', error);
        } finally {
            setLoading(false);
        }
    };
    
    return (
        <div className="chatbot-container">
            <div className="messages-list">
                {messages.map((msg, index) => (
                    <div key={index} className={`message ${msg.role}`}>
                        <p>{msg.content}</p>
                    </div>
                ))}
                {loading && <LoadingIndicator />}
            </div>
            <div className="input-area">
                <input 
                    value={input}
                    onChange={(e) => setInput(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                    placeholder="Posez votre question médicale..."
                />
                <button onClick={sendMessage}>Envoyer</button>
            </div>
        </div>
    );
}
\end{verbatim}

\section{CONCLUSION}
Ce chapitre a présenté la réalisation du sprint 3 focalisé sur l'espace patient et l'innovation majeure du chatbot médical intelligent. Nous avons développé un système d'inscription sécurisée avec vérification par email utilisant des tokens uniques à durée limitée, garantissant l'authenticité des comptes patients. La consultation des dossiers médicaux permet aux patients d'accéder à leur historique complet en toute sécurité, avec possibilité de télécharger leurs documents médicaux en respectant le RGPD.

L'intégration du chatbot basé sur l'API OpenAI GPT-4 constitue l'apport technologique majeur de ce sprint. Ce chatbot offre une assistance médicale virtuelle accessible 24/7, capable de répondre aux questions générales des patients tout en les orientant vers une consultation médicale pour les symptômes graves. L'historique complet des conversations est sauvegardé pour traçabilité et amélioration continue du service.

L'ensemble des trois sprints (espace médecin, assistant et patient) forme maintenant un système complet de gestion de cabinet médical moderne, sécurisé et innovant, intégrant les dernières avancées de l'intelligence artificielle au service de la santé. Le chapitre suivant présentera l'environnement de développement, les outils utilisés, les tests effectués et les perspectives d'évolution du système.
